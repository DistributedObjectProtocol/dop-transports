# CONNECTIVITY PROTOCOL PROPOSAL

`SERVER` and `CLIENT` are both nodes instances in the dop world.

## CONNECT, RECONNECT AND DISCONNECT FLOW

---

1. CONNECTION OPENED VIA WEBSOCKETS
2. BOTH SENDS THEIR TOKEN

```
SERVER
- STATUS: OPEN
- TOKEN: AAA
- SOCKET: 1

CLIENT
- STATUS: OPEN
- TOKEN: BBB
- SOCKET: 1
```

3. BOTH MERGE THEIR TOKEN INTO THE SAME ONE
4. STATUS IS NOW CONNECTED

```
SERVER
- STATUS: CONNECTED
- TOKEN: AAABBB
- SOCKET: 1

CLIENT
- STATUS: CONNECTED
- TOKEN: AAABBB
- SOCKET: 1
```

5. SOCKET IS CLOSED
6. BOTH CHANGE THE STATUS TO RECONNECTING

```
SERVER
- STATUS: RECONNECTING
- TOKEN: AAABBB
- SOCKET: 1 (closed)

CLIENT
- STATUS: RECONNECTING
- TOKEN: AAABBB
- SOCKET: 1 (closed)
```

7. CLIENT TRY TO RECCONNECT OPENING A NEW SOCKET
8. CLIENT CHANGE STATUS TO
9. CLIENT SENDS THE SAME OLD TOKEN AS RECONNECT INSTRUNCTION
10. A NEW NODE IS CREATED ON THE SERVER SIDE

```
SERVER1
- STATUS: RECONNECTING
- TOKEN: AAABBB
- SOCKET: 1 (closed)
SERVER2
- STATUS: OPEN
- TOKEN: CCC
- SOCKET: 2

CLIENT
- STATUS: PRECONNECTED
- TOKEN: AAABBB
- SOCKET: 2
```

11. SERVER2 RECEIVE THE OLD TOKEN
12. SOCKET2 IS ASSIGNED TO SERVER1
13. SERVER1 IS NOW AS CONNECTED
14. WE DESTROY SERVER2
15. SERVER1 SENDS THE TOKEN AS INSTRUNCTION TO RECONNECT

```
SERVER1
- STATUS: CONNECTED
- TOKEN: AAABBB
- SOCKET: 2

CLIENT
- STATUS: PRECONNECTED
- TOKEN: AAABBB
- SOCKET: 2
```

16. CLIENT RECEIVE TOKEN SERVER1
17. CLIENT CHANGE STATUS TO CONNECTED

```
SERVER1
- STATUS: CONNECTED
- TOKEN: AAABBB
- SOCKET: 2

CLIENT
- STATUS: CONNECTED
- TOKEN: AAABBB
- SOCKET: 2
```

18. SERVER1 RUN DISCONNECT
19. SERVER1 SENDS TOKEN TO THE CLIENT AS DISCONNECT INSTRUCTION
20. SERVER1 CHANGE STATUS TO DISCONNECTED
21. SERVER1 CLOSE SOCKET

```
SERVER1 (deleted)
- STATUS: DISCONNECTED
- TOKEN: AAABBB
- SOCKET: 2

CLIENT
- STATUS: CONNECTED
- TOKEN: AAABBB
- SOCKET: 2
```

22. CLIENT RECEIVE TOKEN
23. CLIENT CHANGE STATUS TO DISCONNECTED
24. SOCKET2 IS CLOSED

```
SERVER1 (deleted)
- STATUS: DISCONNECTED
- TOKEN: AAABBB
- SOCKET: 2 (closed)

CLIENT (deleted)
- STATUS: DISCONNECTED
- TOKEN: AAABBB
- SOCKET: 2 (closed)
```

## RECONNECTION FROM CLIENT MUST FAIL IF SERVER FINNALY DISCONNECT

We recover the state from `6` which is the one after SOCKET is closed

```
SERVER
- STATUS: RECONNECTING
- TOKEN: AAABBB
- SOCKET: 1 (closed)

CLIENT
- STATUS: RECONNECTING
- TOKEN: AAABBB
- SOCKET: 1 (closed)
```

7. We set SERVER as DISCONNECTED which means is also deleted from memory

```
SERVER (deleted)
- STATUS: DISCONNECTED
- TOKEN: AAABBB
- SOCKET: 1 (closed)

CLIENT
- STATUS: RECONNECTING
- TOKEN: AAABBB
- SOCKET: 1 (closed)
```

8. CLIENT then try to reconnect because don't know is a finnaly disconnection.
9. CLIENT sends token to try reconnection.
10. SERVER2 cant recover that deleted token.

```
SERVER2
- STATUS: OPEN
- TOKEN: CCC
- SOCKET: 2

CLIENT
- STATUS: PRECONNECTED
- TOKEN: AAABBB
- SOCKET: 2
```
